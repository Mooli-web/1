{% extends 'base.html' %}
{% load static %}
{% load jalali_tags %}
{% load humanize %}
{# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù„ÙˆØ¯ ØªÚ¯â€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ #}
{% load reception_tags %}

{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ù† | Ú©Ù„ÛŒÙ†ÛŒÚ© Ø²ÛŒØ¨Ø§ÛŒÛŒ{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h2 class="fw-bold text-dark">Ø³Ù„Ø§Ù…ØŒ {{ user.first_name|default:"Ú©Ø§Ø±Ø¨Ø± Ú¯Ø±Ø§Ù…ÛŒ" }} <span class="fs-4">ğŸ‘‹</span></h2>
            <p class="text-muted">Ø¨Ù‡ Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="{% url 'users:profile_update' %}" class="btn btn-outline-primary rounded-pill px-4">
                <i class="bi bi-gear me-2"></i>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø³Ø§Ø¨
            </a>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 bg-primary text-white h-100 overflow-hidden position-relative">
                <div class="card-body p-4 position-relative z-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="opacity-75 mb-1">Ø§Ù…ØªÛŒØ§Ø² ÙˆÙØ§Ø¯Ø§Ø±ÛŒ</h6>
                            <h1 class="fw-bold mb-0 display-5">{{ user_points }}</h1>
                        </div>
                        <div class="bg-white bg-opacity-25 p-2 rounded-3">
                            <i class="bi bi-stars fs-3"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 small opacity-75"><i class="bi bi-info-circle me-1"></i>Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ®ÙÛŒÙ Ø¯Ø± Ø±Ø²Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ</p>
                </div>
                <i class="bi bi-trophy-fill position-absolute bottom-0 end-0 text-white opacity-10" style="font-size: 8rem; transform: rotate(-20deg) translate(20%, 20%);"></i>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center text-center">
                    {% if appointments and appointments.0.status != 'DONE' and appointments.0.status != 'CANCELED' %}
                        <div class="text-primary mb-2"><i class="bi bi-calendar-check fs-1"></i></div>
                        <h6 class="fw-bold text-dark">Ù†ÙˆØ¨Øª Ø¨Ø¹Ø¯ÛŒ Ø´Ù…Ø§</h6>
                        {# Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² jalali_format Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙØ§Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ #}
                        <p class="text-primary fs-5 mb-1 fw-bold">{{ appointments.0.start_time|jalali_format:'%A %d %B' }}</p>
                        <span class="badge bg-light text-dark border">{{ appointments.0.start_time|jalali_format:'%H:%M' }}</span>
                    {% else %}
                        <div class="text-muted mb-2"><i class="bi bi-calendar-plus fs-1"></i></div>
                        <h6 class="text-dark">Ù†ÙˆØ¨Øª ÙØ¹Ø§Ù„ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</h6>
                        <a href="{% url 'booking:create_booking' %}" class="btn btn-sm btn-primary mt-2 rounded-pill px-3">Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0">Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h6>
                        <span class="badge bg-light text-dark">{{ transactions.count }}</span>
                    </div>
                    {% if transactions %}
                        <ul class="list-unstyled mb-0">
                            {% for txn in transactions|slice:":3" %}
                            <li class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom border-light last-no-border">
                                <div>
                                    <small class="d-block fw-bold text-dark">{{ txn.amount|intcomma }} <span class="text-muted" style="font-size: 0.7em;">ØªÙˆÙ…Ø§Ù†</span></small>
                                    {# Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ #}
                                    <small class="text-muted" style="font-size: 0.7em;">{{ txn.created_at|jalali_format:'%Y/%m/%d' }}</small>
                                </div>
                                {% if txn.status == 'SUCCESS' %}
                                    <i class="bi bi-arrow-down-left-circle-fill text-success"></i>
                                {% else %}
                                    <i class="bi bi-x-circle-fill text-danger"></i>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted small text-center my-4">ØªØ±Ø§Ú©Ù†Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white border-bottom py-3 px-4 d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§</h5>
            <a href="{% url 'booking:create_booking' %}" class="btn btn-primary btn-sm rounded-pill px-3">
                <i class="bi bi-plus-lg me-1"></i>Ø±Ø²Ø±Ùˆ Ø¬Ø¯ÛŒØ¯
            </a>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-muted small text-uppercase">
                    <tr>
                        <th class="ps-4 py-3">Ø®Ø¯Ù…Øª</th>
                        <th>Ø²Ù…Ø§Ù†</th>
                        <th>ÙˆØ¶Ø¹ÛŒØª</th>
                        <th>Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ</th>
                        <th class="text-end pe-4">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                    </tr>
                </thead>
                <tbody class="border-top-0">
                    {% for appt in appointments %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold text-dark">{{ appt.get_services_display }}</div>
                            {% if appt.selected_device %}
                                <small class="text-muted">{{ appt.selected_device.name }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {# Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ #}
                            <div class="text-dark">{{ appt.start_time|jalali_format:'%Y/%m/%d' }}</div>
                            <small class="text-muted">{{ appt.start_time|jalali_format:'%H:%M' }}</small>
                        </td>
                        <td>
                            {% if appt.status == 'PENDING' %}
                                <span class="badge bg-warning text-dark rounded-pill px-3">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª</span>
                            {% elif appt.status == 'CONFIRMED' %}
                                <span class="badge bg-success rounded-pill px-3">ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span>
                            {% elif appt.status == 'DONE' %}
                                <span class="badge bg-info rounded-pill px-3">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</span>
                            {% elif appt.status == 'CANCELED' %}
                                <span class="badge bg-secondary rounded-pill px-3">Ù„ØºÙˆ Ø´Ø¯Ù‡</span>
                            {% endif %}
                        </td>
                        <td class="text-muted small font-monospace">
                            {% if appt.transaction and appt.transaction.status == 'SUCCESS' %}
                                {{ appt.transaction.authority|default:"-"|truncatechars:10 }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-end pe-4">
                            {% if appt.status == 'PENDING' %}
                                <a href="{% url 'payment:start_payment' appt.tracking_code %}" class="btn btn-success btn-sm rounded-pill px-3">
                                    Ù¾Ø±Ø¯Ø§Ø®Øª
                                </a>
                            {% endif %}
                            {% if appt.status == 'DONE' and not appt.is_rated %}
                                <a href="{% url 'booking:rate_appointment' appt.id %}" class="btn btn-outline-warning btn-sm rounded-pill px-3">
                                    <i class="bi bi-star-fill me-1"></i>Ø«Ø¨Øª Ù†Ø¸Ø±
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="bi bi-calendar-x display-4 d-block mb-3 opacity-50"></i>
                            Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ù†ÙˆØ¨ØªÛŒ Ø±Ø²Ø±Ùˆ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .last-no-border:last-child { border-bottom: none !important; margin-bottom: 0 !important; padding-bottom: 0 !important; }
</style>
{% endblock %}